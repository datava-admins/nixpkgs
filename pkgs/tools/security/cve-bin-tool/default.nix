{ lib
#, buildPythonApplication
, python310
, fetchFromGitHub
, jsonschema
, plotly
, beautifulsoup4
, pyyaml
, isort
, py
, jinja2
, rpmfile
, reportlab
, zstandard
, rich
, aiohttp
, toml
, distro
  # aiohttp[speedups]
, aiodns
, brotlipy
, cchardet
, pillow
, pytestCheckHook
, xmlschema
, setuptools
, packaging
, cvss
, google-cloud-sdk
, php81Packages
}:
let
  pythonEnv = python310.withPackages (p: with p; [ pip ]);
in
pythonEnv.pkgs.buildPythonApplication rec {
  pname = "cve-bin-tool";
  version = "snapshot";

  python = pythonEnv;

  src = fetchFromGitHub {
    owner = "Princemachiavelli";
    repo = "cve-bin-tool";
    rev = "e2beaa9987015acc7b01599515e0dbbf4f7c7710";
    sha256 = "";
  };

  patches = [
    # Not needed as python dependency, should just be on the PATH
    ./no-gsutil-python-dependency.patch
  ];

  # Wants to open a sqlite database, access the internet, etc
  doCheck = false;

  propagatedBuildInputs = [
    pythonEnv
    google-cloud-sdk
    jsonschema
    plotly
    beautifulsoup4
    pyyaml
    isort
    py
    jinja2
    rpmfile
    reportlab
    zstandard
    rich
    aiohttp
    toml
    distro
    # aiohttp[speedups]
    aiodns
    brotlipy
    cchardet
    # needed by brotlipy
    pillow
    setuptools
    xmlschema
    packaging
    cvss
    php81Packages.composer
  ];

  checkInputs = [
    pytestCheckHook
  ];

  pythonImportsCheck = [
    "cve_bin_tool"
  ];


  postFixup = ''
    sed -i '1s;^;#!${pythonEnv.interpreter}\n;' $out/bin/.cve-bin-tool-wrapped 
    sed -i '1s;^;#!${pythonEnv.interpreter}\n;' $out/bin/.csv2cve-wrapped
  '';
#  makeWrapperArgs = [
#    "--prefix PATH : ${lib.makeBinPath [ pythonEnv.pkgs.pip ]}"
#    "--set PYTHONPATH ${pythonEnv}"
#  ];
  # required until https://github.com/intel/cve-bin-tool/pull/1665 is merged
  postPatch = ''
    sed '/^pytest/d' -i requirements.txt
  '';

  meta = with lib; {
    description = "CVE Binary Checker Tool";
    homepage = "https://github.com/intel/cve-bin-tool";
    license = licenses.gpl3Plus;
    maintainers = teams.determinatesystems.members;
  };
}
